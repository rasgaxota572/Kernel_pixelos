name: build-kernel

on:
  push:
    branches: [ main ]
    paths:
      - 'arch/arm64/configs/exynos9830_defconfig'
  pull_request:
    branches: [ main ]
    paths:
      - 'arch/arm64/configs/exynos9830_defconfig'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if exynos9830_defconfig is not modified (manual trigger)'
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up environment
        run: |
          sudo apt-get update
          # Consolidated apt install for better efficiency
          sudo apt install -y build-essential libncurses5-dev zlib1g-dev libssl-dev libffi-dev libreadline-dev libbz2-dev libsqlite3-dev make gcc pigz cpio lld llvm g++-aarch64-linux-gnu libelf-dev clang gcc-arm-linux-gnueabi gcc-aarch64-linux-gnu neofetch libarchive-tools ccache
          
          neofetch

      - name: Build Kernel
        run: |
          chmod +x ./build_kernel.sh
          # The script is assumed to place Image.gz in arch/arm64/boot/
          ./build_kernel.sh

      - name: Package Kernel to Flashable Zip ðŸ“¦
        run: |
          # 1. Clone a kernel flashing template (e.g., AnyKernel3)
          git clone --depth 1 https://github.com/osm0sis/AnyKernel3 AnyKernel3
          
          # 2. Copy the newly built kernel image (Image.gz) into the AnyKernel3 directory
          # Note: Adjust the source path if your build script puts Image.gz elsewhere.
          cp arch/arm64/boot/Image.gz AnyKernel3/
          
          # Optional: Copy other components like dtb, modules, etc., if needed
          # cp path/to/dtb AnyKernel3/
          
          # 3. Create the final flashable zip
          ZIP_NAME="R8S-Kernel-$(date +%Y%m%d%H%M).zip"
          cd AnyKernel3
          zip -r9 "../$ZIP_NAME" *
          cd ..
          
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "Package created: $ZIP_NAME"

      - name: Find built zips
        id: find_zips
        run: |
          # Now, it should find the ZIP created in the previous step
          ZIP_FILES=$(find . -type f -name "*.zip")
          if [[ -z "$ZIP_FILES" ]]; then
            echo "No ZIPs found! Exiting."
            exit 1
          fi
          # The $GITHUB_ENV is already set by the previous step, but we ensure 
          # ZIP_FILES is set for robustness and handling multiple zips if necessary.
          echo "ZIP_FILES<<EOF" >> $GITHUB_ENV
          echo "$ZIP_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Upload built kernels
        uses: actions/upload-artifact@v4
        with:
          name: built-kernels
          # The path must be the exact file name(s), which we ensure is set in the Package step
          path: ${{ env.ZIP_NAME }}
